<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Binary">
    <title>Binary</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNjg2ZqtsUmoXcMq-guhJAPwY9lIUNPkI&libraries=places" async defer></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    
<script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;

// === Firebase (unchanged) ===
/* … keep the firebaseConfig, init, icons, categories, etc. … */

// ---------------------------------------------------------------
//  NEW: UserProfile component (the page you visit)
// ---------------------------------------------------------------
function UserProfile({ targetUid, onBack, currentUser }) {
  const [profileUser, setProfileUser] = useState(null);
  const [profileItems, setProfileItems] = useState([]);
  const [selectedCategory, setSelectedCategory] = useState('All');
  const [loading, setLoading] = useState(true);

  // Load user doc + items
  useEffect(() => {
    let unsubItems;
    (async () => {
      const userDoc = await db.collection('users').doc(targetUid).get();
      if (!userDoc.exists) { setLoading(false); return; }
      setProfileUser({ id: userDoc.id, ...userDoc.data() });

      // Listen to items of this user (public only)
      unsubItems = db.collection('items')
        .where('userId', '==', targetUid)
        .where('isPublic', '==', true)
        .orderBy('timestamp', 'desc')
        .onSnapshot(snap => {
          const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          setProfileItems(items);
          setLoading(false);
        });
    })();
    return () => unsubItems && unsubItems();
  }, [targetUid]);

  const filtered = useMemo(() => {
    if (selectedCategory === 'All') return profileItems;
    return profileItems.filter(i => i.category === selectedCategory);
  }, [profileItems, selectedCategory]);

  if (loading) return <div className="p-8 text-center">Loading profile…</div>;
  if (!profileUser) return <div className="p-8 text-center">User not found</div>;

  return (
    <div className="max-w-2xl mx-auto px-4 py-6">
      {/* Header */}
      <div className="flex items-center gap-4 mb-6">
        <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        </button>
        <div className="flex-1">
          <h2 className="text-2xl font-bold text-gray-800">{profileUser.displayName}</h2>
          <p className="text-sm text-gray-500">Public ratings</p>
        </div>
      </div>

      {/* Category filter */}
      {profileItems.length > 0 && (
        <div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
          <div className="flex items-center gap-2 mb-3">
            <Filter />
            <span className="font-semibold text-gray-700">Filter by category:</span>
          </div>
          <div className="flex flex-wrap gap-2">
            {['All', ...ALL_CATEGORIES].map(cat => (
              <button
                key={cat}
                onClick={() => setSelectedCategory(cat)}
                className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                  selectedCategory === cat
                    ? 'bg-purple-500 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {cat}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Items */}
      <div className="space-y-3">
        {filtered.length === 0 ? (
          <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
            <p className="text-gray-500">
              {profileItems.length === 0 ? 'No public ratings yet.' : 'No items in this category.'}
            </p>
          </div>
        ) : (
          filtered.map(item => <ItemCard key={item.id} item={item} view="public" currentUser={currentUser} />)
        )}
      </div>
    </div>
  );
}

// ---------------------------------------------------------------
//  REUSABLE ItemCard (extracted for DRY)
// ---------------------------------------------------------------
function ItemCard({ item, view, currentUser, onVisitProfile }) {
  const isOwn = item.userId === currentUser.uid;
  const getRatingEmoji = r => r === 'like' ? 'Like' : 'Dislike';
  const getRatingColor = r => r === 'like'
    ? 'bg-green-100 text-green-800 border-green-300'
    : 'bg-red-100 text-red-800 border-red-300';

  return (
    <div className="bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <div className="flex items-center gap-2 mb-1 flex-wrap">
            <span className={`px-3 py-1 rounded-full text-sm font-semibold border-2 ${getRatingColor(item.rating)}`}>
              {getRatingEmoji(item.rating)} {item.rating === 'like' ? 'Liked' : 'Disliked'}
            </span>

            <span className="px-3 py-1 rounded-full text-xs font-medium border bg-purple-100 text-purple-700">
              {item.category}
            </span>

            {view === 'public' && !isOwn && item.userName && (
              <button
                onClick={() => onVisitProfile?.(item.userId)}
                className="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 flex items-center gap-1 hover:bg-gray-200"
              >
                <Users />
                {item.userName}
              </button>
            )}
            {view === 'public' && isOwn && (
              <span className="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
                You
              </span>
            )}
          </div>

          <p className="text-gray-800 font-medium mb-1">{item.text}</p>
          <p className="text-sm text-gray-500">{item.date}</p>

          {item.comment && (
            <div className="mt-2 p-3 bg-gray-50 rounded-lg">
              <p className="text-sm text-gray-700 italic">{item.comment}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ---------------------------------------------------------------
//  MAIN APP
// ---------------------------------------------------------------
function BinaryApp() {
  const [user, setUser] = useState(null);
  const [items, setItems] = useState([]);
  const [publicItems, setPublicItems] = useState([]);
  const [following, setFollowing] = useState([]);
  const [view, setView] = useState('my');               // 'my' | 'public' | 'profile'
  const [profileTarget, setProfileTarget] = useState(null); // uid when view==='profile'

  const [selectedCategory, setSelectedCategory] = useState('All');
  const [inputText, setInputText] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  const [showUserSearch, setShowUserSearch] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);

  const [message, setMessage] = useState(null);

  // -----------------------------------------------------------------
  //  Auth + initial data
  // -----------------------------------------------------------------
  useEffect(() => {
    const unsub = auth.onAuthStateChanged(async u => {
      setUser(u);
      if (u) {
        await Promise.all([loadMyItems(u.uid), loadFollowing(u.uid)]);
      }
      setIsLoading(false);
    });
    return unsub;
  }, []);

  // -----------------------------------------------------------------
  //  Public feed (my + followed users)
  // -----------------------------------------------------------------
  useEffect(() => {
    if (view === 'public' && user) loadPublicFeed();
  }, [view, following, user]);

  // -----------------------------------------------------------------
  //  Search users (debounced)
  // -----------------------------------------------------------------
  useEffect(() => {
    const t = setTimeout(() => {
      if (searchQuery.trim()) searchUsers(searchQuery);
      else setSearchResults([]);
    }, 300);
    return () => clearTimeout(t);
  }, [searchQuery]);

  // -----------------------------------------------------------------
  //  Helpers
  // -----------------------------------------------------------------
  const showMessage = (txt, type = 'success') => {
    setMessage({ txt, type });
    setTimeout(() => setMessage(null), 3000);
  };

  const loadMyItems = async uid => {
    const snap = await db.collection('items')
      .where('userId', '==', uid)
      .orderBy('timestamp', 'desc')
      .get();
    setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })));
  };

  const loadFollowing = async uid => {
    const snap = await db.collection('follows')
      .where('followerId', '==', uid)
      .get();
    setFollowing(snap.docs.map(d => d.data().followingId));
  };

  const loadPublicFeed = async () => {
    const uids = [user.uid, ...following];
    if (!uids.length) { setPublicItems([]); return; }

    const batches = [];
    for (let i = 0; i < uids.length; i += 10) {
      const batch = uids.slice(i, i + 10);
      const snap = await db.collection('items')
        .where('userId', 'in', batch)
        .where('isPublic', '==', true)
        .orderBy('timestamp', 'desc')
        .limit(50)
        .get();

      const items = await Promise.all(
        snap.docs.map(async doc => {
          const data = doc.data();
          const uDoc = await db.collection('users').doc(data.userId).get();
          const u = uDoc.data() || {};
          return {
            id: doc.id,
            ...data,
            userName: u.displayName || 'Anonymous',
            isOwnItem: data.userId === user.uid
          };
        })
      );
      batches.push(...items);
    }
    batches.sort((a, b) => b.timestamp - a.timestamp);
    setPublicItems(batches.slice(0, 50));
  };

  const searchUsers = async q => {
    const snap = await db.collection('users').get();
    const hits = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(u => u.id !== user?.uid &&
        (u.displayName?.toLowerCase().includes(q.toLowerCase()) ||
         u.email?.toLowerCase().includes(q.toLowerCase())));
    setSearchResults(hits);
  };

  const followUser = async (targetId) => {
    if (following.includes(targetId)) return showMessage('Already following');
    await db.collection('follows').doc(`${user.uid}_follows_${targetId}`).set({
      followerId: user.uid,
      followingId: targetId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    setFollowing([...following, targetId]);
    showMessage('Now following');
  };

  const unfollowUser = async (targetId) => {
    await db.collection('follows').doc(`${user.uid}_follows_${targetId}`).delete();
    setFollowing(following.filter(id => id !== targetId));
    showMessage('Unfollowed');
    if (view === 'public') loadPublicFeed();
  };

  // -----------------------------------------------------------------
  //  Item actions (add / delete / toggle / comment …)
  // -----------------------------------------------------------------
  const addItem = async rating => {
    if (!inputText.trim() || isProcessing) return;
    setIsProcessing(true);
    try {
      const cat = await detectCategory(inputText);
      const payload = {
        text: inputText.trim(),
        rating,
        category: cat,
        timestamp: Date.now(),
        date: new Date().toLocaleDateString(),
        userId: user.uid,
        isPublic: true
      };
      const ref = await db.collection('items').add({
        ...payload,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setItems(prev => [{ id: ref.id, ...payload }, ...prev]);
      setInputText('');
      showMessage('Added!');
    } catch (e) { console.error(e); showMessage('Error', 'error'); }
    finally { setIsProcessing(false); }
  };

  const deleteItem = async id => {
    await db.collection('items').doc(id).delete();
    setItems(prev => prev.filter(i => i.id !== id));
    showMessage('Deleted');
  };

  const togglePublic = async (id, cur) => {
    await db.collection('items').doc(id).update({ isPublic: !cur });
    setItems(prev => prev.map(i => i.id === id ? { ...i, isPublic: !cur } : i));
    showMessage(cur ? 'Now private' : 'Now public');
  };

  // -----------------------------------------------------------------
  //  Navigation to profile
  // -----------------------------------------------------------------
  const visitProfile = uid => {
    if (!following.includes(uid)) {
      showMessage('You must follow this user to see their page', 'error');
      return;
    }
    setView('profile');
    setProfileTarget(uid);
  };
  const backFromProfile = () => {
    setView('public');
    setProfileTarget(null);
  };

  // -----------------------------------------------------------------
  //  Render helpers
  // -----------------------------------------------------------------
  const currentItems = view === 'my' ? items
                     : view === 'public' ? publicItems
                     : []; // profile uses its own list

  const filteredItems = useMemo(() => {
    if (selectedCategory === 'All') return currentItems;
    return currentItems.filter(i => i.category === selectedCategory);
  }, [currentItems, selectedCategory]);

  // -----------------------------------------------------------------
  //  UI
  // -----------------------------------------------------------------
  if (!user) {
    return (/* login screen – unchanged */);
  }
  if (isLoading) return <div className="min-h-screen flex items-center justify-center">Loading…</div>;

  // ---------- PROFILE VIEW ----------
  if (view === 'profile' && profileTarget) {
    return <UserProfile targetUid={profileTarget} onBack={backFromProfile} currentUser={user} />;
  }

  // ---------- MAIN VIEWS ----------
  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 pb-6">
      <div className="max-w-2xl mx-auto px-4 py-6">

        {/* messages */}
        {message && (
          <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium ${message.type==='error'?'bg-red-500':'bg-green-500'}`}>
            {message.txt}
          </div>
        )}

        {/* USER SEARCH MODAL */}
        {showUserSearch && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col">
              <div className="p-6 border-b flex items-center justify-between">
                <h2 className="text-2xl font-bold text-gray-800">Find Users</h2>
                <button onClick={()=>{setShowUserSearch(false);setSearchQuery('');setSearchResults([]);}}
                        className="p-2 hover:bg-gray-100 rounded-lg"><X /></button>
              </div>

              <div className="p-6">
                <div className="relative">
                  <Search className="absolute left-3 top-3 text-gray-400" />
                  <input type="text" value={searchQuery} onChange={e=>setSearchQuery(e.target.value)}
                         placeholder="Search by name…" className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:outline-none" autoFocus />
                </div>
              </div>

              <div className="flex-1 overflow-y-auto px-6 pb-6">
                {searchResults.length === 0 && searchQuery && <p className="text-center text-gray-500 py-8">No users found</p>}
                {searchResults.length === 0 && !searchQuery && <p className="text-center text-gray-500 py-8">Start typing…</p>}

                <div className="space-y-3">
                  {searchResults.map(u => (
                    <div key={u.id} className="bg-gray-50 rounded-xl p-4 flex items-center justify-between">
                      <div>
                        <p className="font-semibold text-gray-800">{u.displayName}</p>
                        {/* email removed from UI */}
                      </div>
                      {following.includes(u.id) ? (
                        <button onClick={()=>unfollowUser(u.id)}
                                className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium flex items-center gap-2">
                          <UserMinus /> Unfollow
                        </button>
                      ) : (
                        <button onClick={()=>followUser(u.id)}
                                className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium flex items-center gap-2">
                          <UserPlus /> Follow
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* HEADER */}
        <div className="text-center mb-6">
          <div className="flex items-center justify-between mb-2">
            <button onClick={()=>setShowUserSearch(true)} className="p-2 text-purple-600 hover:bg-purple-50 rounded-lg"><Search /></button>
            <h1 className="text-3xl font-bold text-gray-800">Binary</h1>
            <button onClick={signOut} className="p-2 text-gray-600 hover:text-red-500 hover:bg-red-50 rounded-lg"><LogOut /></button>
          </div>
          <p className="text-gray-600">Welcome, {user.displayName}!</p>
        </div>

        {/* VIEW TOGGLE */}
        <div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
          <div className="flex gap-2">
            <button onClick={()=>setView('my')}
                    className={`flex-1 py-3 px-4 rounded-xl font-semibold flex items-center justify-center gap-2 ${view==='my'?'bg-purple-500 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
              <Lock /> My Items ({items.length})
            </button>
            <button onClick={()=>setView('public')}
                    className={`flex-1 py-3 px-4 rounded-xl font-semibold flex items-center justify-center gap-2 ${view==='public'?'bg-purple-500 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
              <Globe /> Feed
            </button>
          </div>
        </div>

        {/* INPUT (only on My view) */}
        {view === 'my' && (
          <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <input type="text" value={inputText} onChange={e=>setInputText(e.target.value)}
                   placeholder="What did you experience?" className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:outline-none mb-4"
                   onKeyPress={e=>e.key==='Enter' && inputText.trim() && !isProcessing && document.getElementById('like-btn')?.focus()} disabled={isProcessing} />
            <div className="flex gap-3">
              <button id="like-btn" onClick={()=>addItem('like')} disabled={!inputText.trim()||isProcessing}
                      className="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2">
                <ThumbsUp /> {isProcessing?'…':'Like'}
              </button>
              <button onClick={()=>addItem('dislike')} disabled={!inputText.trim()||isProcessing}
                      className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2">
                <ThumbsDown /> {isProcessing?'…':'Dislike'}
              </button>
            </div>
          </div>
        )}

        {/* CATEGORY FILTER (appears on every view that has items) */}
        {currentItems.length > 0 && (
          <div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
            <div className="flex items-center gap-2 mb-3">
              <Filter />
              <span className="font-semibold text-gray-700">Filter by category:</span>
            </div>
            <div className="flex flex-wrap gap-2">
              {['All', ...ALL_CATEGORIES].map(c => (
                <button key={c} onClick={()=>setSelectedCategory(c)}
                        className={`px-4 py-2 rounded-lg font-medium ${selectedCategory===c?'bg-purple-500 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                  {c}
                </button>
              ))}
            </div>
          </div>
        )}

        {/* ITEMS LIST */}
        <div className="space-y-3">
          {filteredItems.length === 0 ? (
            <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
              <div className="text-6xl mb-4">{view==='public'?'Globe':'Page'}</div>
              <p className="text-gray-500">
                {view==='public' ? (following.length===0 ? 'Follow users to see their ratings!' : 'No public items yet')
                : view==='my' ? (items.length===0 ? 'Start rating!' : 'No items in this category')
                : '—'}
              </p>
              {view==='public' && following.length===0 && (
                <button onClick={()=>setShowUserSearch(true)}
                        className="mt-4 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-semibold flex items-center gap-2 mx-auto">
                  <Search /> Find Users
                </button>
              )}
            </div>
          ) : (
            filteredItems.map(itm => (
              <ItemCard
                key={itm.id}
                item={itm}
                view={view}
                currentUser={user}
                onVisitProfile={visitProfile}
              />
            ))
          )}
        </div>

        {/* MY STATS */}
        {view === 'my' && items.length > 0 && (
          <div className="mt-6 bg-white rounded-2xl shadow-lg p-6">
            <h3 className="font-bold text-gray-800 mb-3">Your Stats</h3>
            <div className="grid grid-cols-2 gap-4">
              <div className="text-center p-4 bg-green-50 rounded-xl">
                <div className="text-3xl font-bold text-green-600">{items.filter(i=>i.rating==='like').length}</div>
                <div className="text-sm text-gray-600">Liked</div>
              </div>
              <div className="text-center p-4 bg-red-50 rounded-xl">
                <div className="text-3xl font-bold text-red-600">{items.filter(i=>i.rating==='dislike').length}</div>
                <div className="text-sm text-gray-600">Disliked</div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

/* ---------- SIGN-IN / SIGN-OUT (unchanged) ---------- */
const signInWithGoogle = async () => { /* … same as before … */ };
const signOut = async () => { /* … same as before … */ };

ReactDOM.render(<BinaryApp />, document.getElementById('root'));
</script>
</body>
</html>
