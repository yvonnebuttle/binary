<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Binary">
    <title>Binary</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script 
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNjg2ZqtsUmoXcMq-guhJAPwY9lIUNPkI&libraries=places"
  async defer>
</script>
</head>
<body>
    <div id="root"></div>
    
<script type="text/babel">
const { useState, useEffect } = React;

// === SVG icons ===
const ThumbsUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>;
const ThumbsDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"/></svg>;
const Mic = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>;
const List = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>;
const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
const Filter = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
const MessageSquare = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;

// === Master category list ===
const ALL_CATEGORIES = [
  'Food', 'Coffee', 'Beverages', 'Places', 'Books', 'Movies',
  'Cheese', 'Dates', 'People', 'Sports', 'Entertainment', 'Things', 'Other'
];

// === Smart category detection ===
    // On page load
let categoryCache = {};
try {
  const storedCache = localStorage.getItem("categoryCache");
  if (storedCache) categoryCache = JSON.parse(storedCache);
} catch(err){ console.warn(err); }

// Save cache
function saveCache() {
  try { localStorage.setItem("categoryCache", JSON.stringify(categoryCache)); }
  catch(err){ console.warn(err); }
}

// Keyword fallbacks for categories
const CATEGORY_KEYWORDS = {
  Food: ["restaurant","cheese","ramen","blueberry","pizza","bread","fruit","food","snack","dinner","lunch","breakfast","meal"],
  Coffee: ["coffee","cafe","latte","espresso","cappuccino","americano"],
  Beverages: ["bar","pub","cocktail","brewery","beer","wine"],
  Places: ["museum","park","beach","city","town","venue","holiday","trip","vacation","tourist_attraction"],
  Things: ["shoes","bike","sneakers","sponges","jacket","laptop","bag","phone","watch","bike","sneakers","runners"],
};
// Helper: wait until Google Maps API is loaded
function waitForGoogleMaps() {
  return new Promise(resolve => {
    if (window.google && window.google.maps) return resolve();
    const interval = setInterval(() => {
      if (window.google && window.google.maps) {
        clearInterval(interval);
        resolve();
      }
    }, 100);
  });
}

// Helper: compute distance in km between two lat/lng points
function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
// Main detection function
async function detectCategory(inputText, userLat, userLng) {
  const text = inputText.trim();
  if (!text) return { category: 'Other', confidence: '0.00', confidenceMap: {} };

  const lower = text.toLowerCase();
  const isCapitalised = /^[A-Z]/.test(text);

  // Check cache first
  if (categoryCache[text]) return categoryCache[text];

  // Initialize confidence map
  const confidence = {};
  ALL_CATEGORIES.forEach(cat => confidence[cat] = 0);

  // --------------------
  // 1️⃣ Google Books API
  // --------------------
  try {
    const bookRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=intitle:${encodeURIComponent(text)}&maxResults=3`);
    const bookData = await bookRes.json();
    if (bookData.items && bookData.items.length > 0) {
      const exact = bookData.items.find(b => b.volumeInfo.title.toLowerCase() === lower);
      confidence.Books = exact ? 0.9 : 0.6;
      if (isCapitalised) confidence.Books += 0.2;
    }
  } catch(err){ console.warn("Books API failed:", err); }

  // --------------------
  // 2️⃣ TMDB Movies API
  // --------------------
  try {
    const tmdbKey = '559458ec6b7148bf5d8a39f7224a2fb8';
    if (tmdbKey !== '559458ec6b7148bf5d8a39f7224a2fb8') {
      const movieRes = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${tmdbKey}&query=${encodeURIComponent(text)}`);
      const movieData = await movieRes.json();
      if (movieData.results && movieData.results.length > 0) {
        const exact = movieData.results.find(m => m.title.toLowerCase() === lower);
        confidence.Movies = exact ? 0.9 : 0.6;
        if (isCapitalised) confidence.Movies += 0.2;
      }
    }
  } catch(err){ console.warn("Movies API failed:", err); }

  // --------------------
  // 3️⃣ Google Places API
  // --------------------
  try {
    await waitForGoogleMaps();
    if (window.google && window.google.maps) {
      await new Promise(resolve => {
        const service = new google.maps.places.AutocompleteService();
        service.getPlacePredictions({ input: text, types: ['establishment'] },
          (predictions, status) => {
            if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions?.length) return resolve();

            const first = predictions[0];
            const detailsService = new google.maps.places.PlacesService(document.createElement('div'));
            detailsService.getDetails({ placeId: first.place_id, fields: ['types','geometry'] },
              (place, detailsStatus) => {
                if (detailsStatus === google.maps.places.PlacesServiceStatus.OK && place?.types) {
                  let nearbyBoost = 0;
                  if (userLat && userLng && place.geometry?.location) {
                    const dist = distanceKm(userLat, userLng, place.geometry.location.lat(), place.geometry.location.lng());
                    if (dist < 5) nearbyBoost = 0.2;
                  }

                  const typeMap = { cafe:'Coffee', bar:'Beverages', pub:'Beverages', restaurant:'Food' };
                  let baseCat = null;
                  for (let t of place.types) if (typeMap[t]) { baseCat = typeMap[t]; break; }
                  if (!baseCat && place.types.some(t => ['park','museum','tourist_attraction','point_of_interest','establishment'].includes(t)))
                    baseCat = 'Places';

                  if (baseCat) confidence[baseCat] = Math.max(confidence[baseCat], 0.6 + nearbyBoost);
                }
                resolve();
              });
          });
      });
    }
  } catch(err){ console.warn("Places detection failed:", err); }

  // --------------------
  // 4️⃣ Keyword fallback
  // --------------------
  for (const [cat, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
    if (keywords.some(k => lower.includes(k))) {
      confidence[cat] = Math.max(confidence[cat], 0.5);
    }
  }

  // --------------------
  // 5️⃣ Select final category
  // --------------------
  const sorted = Object.entries(confidence).sort((a,b) => b[1]-a[1]);
  let [bestCat, bestScore] = sorted[0];
  if (bestScore < 0.4) bestCat = 'Other';

  const result = { category: bestCat, confidence: bestScore.toFixed(2), confidenceMap: confidence };

  // Save to cache & localStorage
  categoryCache[text] = result;
  saveCache();

  return result;

// === Main App ===
function BinaryApp() {
  const [items, setItems] = React.useState([]);
  const [inputText, setInputText] = React.useState('');
  const [selectedCategory, setSelectedCategory] = React.useState('All');
  const [isLoading, setIsLoading] = React.useState(true);
  const [editingComment, setEditingComment] = React.useState(null);
  const [commentText, setCommentText] = React.useState('');

  React.useEffect(() => {
    const stored = localStorage.getItem('binaryItems');
    if (stored) setItems(JSON.parse(stored));
    setIsLoading(false);

    navigator.geolocation.getCurrentPosition(
      pos => { window.userLat = pos.coords.latitude; window.userLng = pos.coords.longitude; },
      err => console.warn('Location denied:', err)
    );
  }, []);

  const saveItems = (newItems) => {
    setItems(newItems);
    localStorage.setItem('binaryItems', JSON.stringify(newItems));
  };

  const addItem = async (rating) => {
    if (!inputText.trim()) return;
    const category = await detectCategory(inputText, window.userLat, window.userLng);
    const newItem = {
      id: Date.now().toString(),
      text: inputText.trim(),
      rating,
      category,
      timestamp: Date.now(),
      date: new Date().toLocaleDateString(),
    };
    saveItems([newItem, ...items]);
    setInputText('');
  };

  const updateCategory = (id, newCat) => {
    saveItems(items.map(item => item.id === id ? { ...item, category: newCat } : item));
  };

  const deleteItem = (id) => saveItems(items.filter(item => item.id !== id));
  const startEditingComment = (item) => { setEditingComment(item.id); setCommentText(item.comment || ''); };
  const saveComment = (id) => { 
    saveItems(items.map(i => i.id === id ? { ...i, comment: commentText.trim() } : i));
    setEditingComment(null); setCommentText('');
  };
  const cancelEditingComment = () => { setEditingComment(null); setCommentText(''); };

  const categories = ['All', ...ALL_CATEGORIES];
  const filteredItems = selectedCategory === 'All' ? items : items.filter(i => i.category === selectedCategory);
  const getRatingEmoji = (rating) => rating === 'like' ? '👍' : '👎';
  const getRatingColor = (rating) => rating === 'like' ? 'bg-green-100 text-green-800 border-green-300' : 'bg-red-100 text-red-800 border-red-300';

  if (isLoading) return <div className="min-h-screen flex items-center justify-center text-gray-600">Loading...</div>;

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 pb-6">
      <div className="max-w-2xl mx-auto px-4 py-6">

        {/* Header */}
        <div className="text-center mb-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-2">Binary</h1>
          <p className="text-gray-600">Yes/no, that's all</p>
        </div>

        {/* Input */}
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div className="flex items-center gap-2 mb-4">
            <div className="relative flex-1">
              <input
                type="text"
                value={inputText}
                onChange={(e) => setInputText(e.target.value)}
                placeholder="What did you experience?"
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:outline-none"
                onKeyPress={(e) => e.key === 'Enter' && inputText.trim() && document.getElementById('like-btn').focus()}
              />
            </div>
          </div>

          <div className="text-xs text-gray-500 mb-3 text-center">
            Tap the microphone icon on your keyboard to use voice input
          </div>

          <div className="flex gap-3">
            <button
              id="like-btn"
              onClick={() => addItem('like')}
              disabled={!inputText.trim()}
              className="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white font-semibold py-3 px-6 rounded-xl flex items-center justify-center gap-2 transition-colors"
            ><ThumbsUp />Like</button>
            <button
              onClick={() => addItem('dislike')}
              disabled={!inputText.trim()}
              className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white font-semibold py-3 px-6 rounded-xl flex items-center justify-center gap-2 transition-colors"
            ><ThumbsDown />Dislike</button>
          </div>
        </div>

        {/* Filter */}
        {items.length > 0 && (
          <div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
            <div className="flex items-center gap-2 mb-3"><Filter /><span className="font-semibold text-gray-700">Filter by category:</span></div>
            <div className="flex flex-wrap gap-2">
              {categories.map(cat => (
                <button
                  key={cat}
                  onClick={() => setSelectedCategory(cat)}
                  className={`px-4 py-2 rounded-lg font-medium transition-colors ${selectedCategory === cat ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                >{cat}</button>
              ))}
            </div>
          </div>
        )}

        {/* Items List */}
        <div className="space-y-3">
          {filteredItems.length === 0 ? (
            <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
              <div className="flex justify-center mb-4"><List /></div>
              <p className="text-gray-500">{items.length === 0 ? "No ratings yet." : "No items in this category yet."}</p>
            </div>
          ) : (
            filteredItems.map(item => (
              <div key={item.id} className="bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <span className={`px-3 py-1 rounded-full text-sm font-semibold border-2 ${getRatingColor(item.rating)}`}>
                        {getRatingEmoji(item.rating)} {item.rating === 'like' ? 'Liked' : 'Disliked'}
                      </span>

                      <select
                        value={item.category}
                        onChange={(e) => updateCategory(item.id, e.target.value)}
                        className="px-3 py-1 rounded-full text-xs font-medium border bg-purple-100 text-purple-700"
                      >
                        {ALL_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                      </select>
                    </div>

                    <p className="text-gray-800 font-medium mb-1">{item.text}</p>
                    <p className="text-sm text-gray-500">{item.date}</p>

                    {editingComment === item.id ? (
                      <div className="mt-3 space-y-2">
                        <textarea
                          value={commentText}
                          onChange={(e) => setCommentText(e.target.value)}
                          placeholder="Add your thoughts..."
                          className="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-400 focus:outline-none resize-none"
                          rows="3"
                          autoFocus
                        />
                        <div className="flex gap-2">
                          <button onClick={() => saveComment(item.id)} className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-medium transition-colors">Save</button>
                          <button onClick={cancelEditingComment} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-medium transition-colors">Cancel</button>
                        </div>
                      </div>
                    ) : (
                      <>
                        {item.comment && (
                          <div className="mt-2 p-3 bg-gray-50 rounded-lg">
                            <p className="text-sm text-gray-700 italic">{item.comment}</p>
                          </div>
                        )}
                        <button onClick={() => startEditingComment(item)} className="mt-2 flex items-center gap-1 text-sm text-purple-600 hover:text-purple-700 font-medium">
                          <MessageSquare />
                          {item.comment ? 'Edit comment' : 'Add comment'}
                        </button>
                      </>
                    )}
                  </div>

                  <button onClick={() => deleteItem(item.id)} className="ml-4 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                    <Trash2 />
                  </button>
                </div>
              </div>
            ))
          )}
        </div>

        {/* Stats */}
        {items.length > 0 && (
          <div className="mt-6 bg-white rounded-2xl shadow-lg p-6">
            <h3 className="font-bold text-gray-800 mb-3">Your Stats</h3>
            <div className="grid grid-cols-2 gap-4">
              <div className="text-center p-4 bg-green-50 rounded-xl">
                <div className="text-3xl font-bold text-green-600">{items.filter(i => i.rating === 'like').length}</div>
                <div className="text-sm text-gray-600">Liked</div>
              </div>
              <div className="text-center p-4 bg-red-50 rounded-xl">
                <div className="text-3xl font-bold text-red-600">{items.filter(i => i.rating === 'dislike').length}</div>
                <div className="text-sm text-gray-600">Disliked</div>
              </div>
            </div>
          </div>
        )}

      </div>
    </div>
  );
}

        ReactDOM.render(<BinaryApp />, document.getElementById('root'));
    </script>
</body>
</html>
