<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Binary">
<title>Binary</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNjg2ZqtsUmoXcMq-guhJAPwY9lIUNPkI&libraries=places" async defer></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback, useMemo } = React;
const AUTH_WORKER_URL = 'https://binary-auth.yvonnebuttle1.workers.dev';
// === Firebase Configuration ===
const firebaseConfig = {
apiKey: "AIzaSyBd6y1rHm7X2u-T1f6PiAmB7lZD9N_5IGc",
authDomain: "binary-97277.firebaseapp.com",
projectId: "binary-97277",
storageBucket: "binary-97277.firebasestorage.app",
messagingSenderId: "394721532495",
appId: "1:394721532495:web:e0b9265dd19fd36e15283a"
};
// Initialize Firebase
let auth, db;
try {
firebase.initializeApp(firebaseConfig);
auth = firebase.auth();
db = firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
} catch (error) {
console.error("Firebase initialization error:", error);
}
// === SVG icons ===
const ThumbsUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>;
const ThumbsDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"/></svg>;
const Filter = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
const MessageSquare = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
const Users = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
const LogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
const Globe = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>;
const Lock = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
const Search = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
const UserPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>;
const UserMinus = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="22" x2="16" y1="11" y2="11"/></svg>;
const X = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
// === Master category list ===
const ALL_CATEGORIES = [
'Food', 'Coffee', 'Pints', 'Places', 'Books', 'Movies',
'Cheese', 'People', 'Activities', 'Culture', 'Things', 'Other', 'Wine', 'Ideas',
];
let categoryCache = {};
try {
const storedCache = localStorage.getItem("categoryCache");
if (storedCache) categoryCache = JSON.parse(storedCache);
} catch(err){ console.warn(err); }
function saveCache() {
try { localStorage.setItem("categoryCache", JSON.stringify(categoryCache)); }
catch(err){ console.warn(err); }
}
// Normalize text for cache lookups
function normalizeForCache(text) {
const fillerWords = [
'a', 'an', 'the', 'at', 'in', 'on', 'to', 'for', 'of', 'with',
'ate', 'had', 'went', 'got', 'saw', 'was', 'did', 'some',
'really', 'very', 'quite', 'pretty', 'just', 'and', 'or'
];

return text
.toLowerCase()
.replace(/[^\w\s]/g, '') // Remove punctuation
.split(/\s+/)
.filter(word => word.length > 2 && !fillerWords.includes(word))
.join(' ')
.trim();
}
async function classifyWithOpenAI(text) {
try {
console.log('ü§ñ Calling Cloudflare Worker...');

const response = await fetch('https://binary-keeper.yvonnebuttle1.workers.dev/', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify({
text: text,
categories: ALL_CATEGORIES
})
});

if (!response.ok) {
const errorBody = await response.text();
console.error('‚ùå Worker error:', response.status, errorBody);
return null;
}

const data = await response.json();
console.log('‚úÖ Worker response:', data);

return data.category;

} catch (error) {
console.error('‚ùå Worker error:', error);
return null;
}
}
const FULL_CATEGORIES = {
'Food': ['ate', 'eating', 'lunch', 'dinner', 'breakfast', 'brunch', 'meal', 'food',
'restaurant', 'bistro', 'diner', 'eatery', 'buffet', 'dish',
'pizza', 'burger', 'sushi', 'pasta', 'salad', 'sandwich', 'soup', 
'steak', 'chicken', 'fish', 'curry', 'ramen', 'taco', 'noodles', 'seafood',
'vegan', 'vegetarian',
'ordered', 'takeout', 'delivery', 'cooked', 'chef',
'italian', 'chinese', 'mexican', 'japanese', 'thai', 'indian', 'french',
'dessert', 'ice cream', 'bakery', 'deli',
'menu', 'cuisine', 'thai', 'indian', 'Mediterranean', 'bbq', 'grill','tasted', 'flavor',
'noodles', 'fries', 'wings', 'nachos', 'burrito', 'falafel', 'gyro', 'pho',
'dim sum', 'bibimbap', 'pad thai', 'duck', 'crab', 'cacio e pepe', 'baklava', 'pork', 'laksa', 'escargot',
'stroganoff', 'katsu', 'tempura', 'onigiri', 'udon', 'soba', 'biryani', 'dosa', 'samosa',
'lobster', 'chowder', 'pie', 'reuben', 'cheeseburger', 'hot dog',
'corn dog', 'mac and cheese', 'grilled', 'BLT', 'wrap', 'quesadilla',
'enchilada', 'empanada', 'arepa', 'pupusa', 'tamale', 'ceviche', 'poke bowl', 'acai bowl',
'quinoa bowl', 'buddha bowl', 'coleslaw',
'hummus', 'tzatziki', 'guacamole', 'salsa', 'chips', 'popcorn', 'pretzel', 'donut', 'bagel', 'croissant',
'muffin', 'pancake', 'waffle', 'french toast', 'eggs', 'omelette', 'quiche', 'frittata',
'hash browns', 'bacon', 'sausage', 'ham', 'turkey', ' beef', 'brisket', 'ribs',
'meatloaf', 'chili', 'stew', 'risotto', 'paella', 'couscous', 'tabbouleh', 'shawarma',
'kebab', 'souvlaki', 'moussaka', 'spanakopita', 'dolma', 'borek', 'knish', 'latke', 'blini', 'pierogi',
'pelmeni', 'vareniki', 'goulash', 'paprikash', 'sauerkraut', 'kimchi', 'japchae', 'bulgogi', 'galbi',
'hot pot', 'shabu shabu', 'sukiyaki', 'okonomiyaki', 'takoyaki', 'gyoza', 'baozi', 'xiaolongbao',
'congee', 'steakhouse', 'fast food', 'fine dining', 'kitchen'
],
'Cheese': [
'cheese',
'cheddar', 'mozzarella', 'parmesan', 'brie', 'feta', 'gouda', 'swiss',
'provolone', 'ricotta', 'camembert', 'gruyere', 'blue cheese', 'goat cheese',
'cream cheese', 'cottage cheese',
'manchego', 'gorgonzola', 'roquefort', 'stilton', 'halloumi', 'burrata',
'pecorino', 'mascarpone', 'raclette', 'paneer', 'havarti',
'durrus', 'cashel blue', 'gubbeen', 'ardrahan', 'coolea', 'carrigaline',
'crozier blue', 'milleens', 'hegarty', 'knockalara',
'aged', 'sharp', 'mild'
],
'Coffee': [
'coffee', 'cafe', 'espresso', 'latte', 'cappuccino', 'americano', 'mocha', 'macchiato', 'cortado',
'flat white', 'cold brew', 'iced coffee', 'frappuccino', 'starbucks', 'barista', 'brew', 'roast',
'tea', 'chai', 'matcha', 'tea', 'boba', 'bubble tea', 'Pukka', 'coffeeshop', 'juice', 'smoothie', 'shake',
],
'Pints': [
'drink', 'drinks', 'drinking', 'pint', 'pints', 'booze', 'alcohol', 'shots',
'pub', 'bar', 'brewery', 'winery', 'boozer', 'tavern',
'beer', 'guinness', 'stout', 'ale', 'lager', 'cider',
'wine', 'whiskey', 'vodka', 'gin', 'rum', 'tequila', 'spirits', 'jameson',
'cocktail', 'martini', 'mojito', 'margarita', 'negroni', 'old fashioned',
'bloody mary', 'irish coffee', 'espresso martini',
],
'Wine': [ 'red wine', 'white wine', 'ros√©', 'champagne', 'prosecco', 'sparkling',
'merlot', 'cabernet', 'pinot', 'chardonnay', 'sauvignon', 'riesling',
'chianti', 'rioja', 'bordeaux', 'burgundy', 'barolo', 'malbec',
'tannins', 'full bodied', 'syrah', 'shiraz', 'tempranillo', 'zinfandel', 'grenache', 'sangiovese', 'nebbiolo',
'carmenere', 'sirah', 'mourvedre', 'viognier', 'gew√ºrztraminer', 'albari√±o', 'chenin blanc', 'semillon',
'verdejo', 'gr√ºner veltliner', 'vermentino', 'moscato', 'brunello',
'chablis', 'sancerre', 'pouilly-fuiss√©'
],
'People': [
'person', 'friend', 'met', 'someone', 'colleague', 'coworker', 'boss', 'manager', 'team', 'neighbour',
'acquaintance', 'stranger', 'conversation', 'chat', 'talked', 'spoke', 'networking', 'social',
'party', 'gathering', 'meetup', 'hangout', 'catch up', 'reunion', 'hung out',
],
'Ideas': ['article', 'essay', 'blog', 'post', 'substack',
'newsletter', 'news', 'piece', 'wrote', 'writing', 'link', 'url', 'https', 'thread', 'opinion', 'philosophy',
'philosophical', 'politics', 'political', 'policy',
'ideology', 'theory', 'argument', 'debate', 'discourse',
'perspective', 'worldview', 'belief', 'viewpoint',
'economics', 'capitalism', 'socialism', 'democracy', 'feminism',
'ethics', 'morality', 'justice', 'rights', 'freedom',
'existentialism', 'stoicism', 'rationalism',
],
'Activities': [
'tennis', 'game', 'played', 'match', 'workout', 'exercise', 'gym', 'fitness', 'training', 'run',
'running', 'jogging', 'cycling', 'swimming', 'yoga', 'pilates', 'crossfit', 'weights', 'cardio',
'basketball', 'soccer', 'football', 'baseball', 'golf', 'volleyball', 'badminton', 'squash',
'hiking', 'climbing', 'boxing', 'martial arts', 'class', 'zumba',  'hobby', 'craft', 'diy', 'project', 'painting', 'drawing', 'art', 'photography', 'photo',
'knitting', 'sewing', 'cooking', 'baking', 'gardening', 'collecting',
'gaming', 'game', 'puzzle', 'lego', 'creative', "football","soccer","basketball","tennis","cricket","rugby","baseball","hockey","golf","swimming","match","championship",
"tournament","volleyball","badminton","wrestling","martial arts","karate","judo","gymnastics","athletics","track","field","surfing","skiing","snowboarding","skateboarding","climbing", "pilates","archery","bmx",
"fencing","handball","lacrosse","netball","polo","squash","water polo","curling","darts","equestrian","fishing",
"formula 1","motocross","nascar","paddleboarding","rowing","sailing","scuba diving","snorkeling","triathlon","frisbee","weightlifting",
"windsurfing","zumba","aerobics","crossfit",
"kickboxing","muay thai","taekwondo","brazilian jiu-jitsu","capoeira","kendo","shooting","bowling","cheerleading","figure skating","speed skating","bobsled",
"luge","skeleton", "snowshoeing","hockey","softball","rounders","korfball","sepak takraw","kabaddi","p√©tanque","bocce","croquet","pickleball","padel",
'date', 'dating', 'went out', 'met up', 'tinder', 'bumble', 'hinge', 'match', 'romance', 'romantic',
'boyfriend', 'girlfriend', 'partner', 'seeing someone', 'relationship', 'first date', 'second date',
'anniversary',
'valentine', 'wedding', 'movie night', 'picnic', 'beach walk', 'walk', 'cycle', 'swim',
'hike', 'cooking', 'stargazing', 'amusement park',
'spa day', 'bike ride', 'kayaking', 'pottery', 'market',
'farmers market', 'sunset cruise', 'lesson', 'escape room', 'hot air balloon', 'massage'
],
'Culture': [
'cinema', 'show', 'season', 'netflix', 'hbo', 'streaming', 'actor', 'director',
'book', 'read', 'novel', 'author', 'podcast', 'music', 'song', 'album', 'concert', 'gig', 'standup', 'stand up',
'performance', 'theater', 'play', 'musical', 'comedy show', 'standup', 'museum', 'gallery', 'band',
'exhibition', 'listened', 'binge', 'anime', 'manga', "concert", 'rave',
"festival","show","performance","theater","theatre","comedy","stand-up","magic","circus","exhibition",
"gig","club","nightclub","disco","rave","party","event","taylor swift tour","beyonce concert","elton john",
"dua lipa show","paul mccartney gig","kendrick lamar festival","haim performance","bad bunny rave","lizzo",
"bono","1975","prince","madonna","aretha franklin","johnny cash","jimi hendrix", "improv","karaoke","open mic",
"poetry slam","burlesque","cabaret","opera","ballet","symphony","jazz","blues","pop","hip hop",
"country music","electronic dance","indie","screening","movie marathon","tv series binge",
"coachella","glastonbury","burning man","sxsw","comic-con","edinburgh fringe", 'music', 'song', 'album',
],
'Things': [
'bought', 'purchased', 'shopping', 'store', 'shop', 'mall', 'online', 'amazon', 'product',
'brand', 'clothes', 'clothing', 'shoes', 'sneakers', 'fashion', 'accessories', 'gadget',
'tech', 'phone', 'laptop', 'computer', 'electronics', 'furniture', 'decor', 'appliance'
],
'Places': [
'visited', 'trip', 'travel', 'vacation', 'holiday', 'flew', 'drove',
'sightseeing', 'explore', 'adventure', 'wanderlust',
'hotel', 'hostel', 'airbnb', 'resort', 'stayed',
'city', 'country', 'beach', 'mountain', 'island', 'lake', 'park', 'garden',
'landmark', 'monument', 'castle', 'palace', 'temple', 'cathedral',
'plaza', 'square', 'attraction', 'tourist',
'temple bar', 'stephens green', 'phoenix park', 'trinity', 'grafton street',
'wicklow', 'howth', 'dun laoghaire', 'dalkey',
'eiffel tower', 'colosseum', 'taj mahal', 'great wall', 'statue of liberty',
'big ben', 'sagrada familia', 'acropolis', 'louvre', 'vatican'
],
'Books': [ 'read', 'reading',
"novel","memoir","biography","poetry","textbook","book","onyx storm","the tenant","one golden summer","my friends","the covenant of water","shield maiden","deep end","first-time caller","scythe and sparrow","rebel witch","famous last words","sunrise on the reaping","wild dark shore",
"broken country","the crash","beautiful ugly","the favorites","witchcraft for wayward girls",
"the midnight library","atomic habits","educated","i'm glad my mom died","the seven husbands of evelyn hugo"
,"the love hypothesis","it ends with us","verity","the silent patient","where the crawdads sing",
"the song of achilles","circe","a court of thorns and roses","the housemaid","the guest list",
"the hunt for red october","1984","to kill a mockingbird","pride and prejudice","great gatsby",
"harry potter and the sorcerer's stone","the da vinci code","the alchemist","sapiens","becoming",
"the power of habit","quiet","daring greatly","the body keeps the score",
"how to win friends and influence people","thinking fast and slow","man's search for meaning",
"the subtle art of not giving a f*ck","milk and honey","the sun and her flowers", "literature",
],
'Movies': [ 'watching',
'movie', "film","documentary","series","episode","the godfather","casablanca","l.a. confidential","seven samurai","parasite","schindler's list","the shawshank redemption","the dark knight","12 angry men","the godfather part ii","pulp fiction","forrest gump","the good the bad and the ugly","the lord of the rings the return of the king","fight club","inception","goodfellas","star wars a new hope","the matrix","se7en","city of god","it's a wonderful life","the silence of the lambs","saving private ryan","life is beautiful","spirited away","interstellar","the green mile","singin' in the rain","the pianist","the lion king","back to the future","american history x","gladiator","the usual suspects","leon the professional","the prestige","memento","whiplash","the intouchables","alien","once upon a time in the west","rear window","psycho","the shining","raiders of the lost ark","toy story","jaws","clockwork orange","the empire strikes back","amadeus","the sting","braveheart","good will hunting","la la land","moonlight","get out","birdman","mad max fury road","spotlight","room","the revenant","the big short","12 years a slave","argo","gravity","her","the wolf of wall street","dallas buyers club","the king's speech","black swan","the social network","the hurt locker","slumdog millionaire","no country for old men","the departed","brokeback mountain","crash","million dollar baby","finding nemo","lord of the rings the fellowship of the ring","titanic","jurassic park", "watched","netflix","disney"
]
};

// Comments collection Firebase ===
const COMMENTS_COLLECTION = 'comments';

// === Mobile detection ===
// === Enhanced Mobile + PWA Detection ===
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isAndroid = /Android/.test(navigator.userAgent);
const isMobile = isIOS || isAndroid;
// IMPROVED PWA detection
const isInStandaloneMode = () => {
// Check both display-mode and navigator.standalone for iOS
return (
window.matchMedia('(display-mode: standalone)').matches || 
('standalone' in window.navigator && window.navigator.standalone === true)
);
};

function waitForGoogleMaps() {
return new Promise(resolve => {
if (window.google && window.google.maps) return resolve();
const interval = setInterval(() => {
if (window.google && window.google.maps) {
clearInterval(interval);
resolve();
}
}, 100);
});
}
function distanceKm(lat1, lon1, lat2, lon2) {
const R = 6371;
const dLat = (lat2 - lat1) * Math.PI / 180;
const dLon = (lon2 - lon1) * Math.PI / 180;
const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
// ===  DETECT CATEGORY FUNCTION WITH CACHING ===
async function detectCategory(inputText, userLat, userLng) {
const text = inputText.trim();
if (!text) return 'Other';

const lower = text.toLowerCase();
const normalized = normalizeForCache(text);
// ---- 1. CHECK CACHE FIRST (highest priority) ----
if (categoryCache[normalized]) {
console.log('‚úÖ Cache hit:', normalized, '‚Üí', categoryCache[normalized]);
return categoryCache[normalized];
}
// ---- 2. PROXIMITY CHECK (Google Maps) ----
if (window.google?.maps && userLat && userLng) {
try {
await waitForGoogleMaps();
const service = new google.maps.places.PlacesService(document.createElement('div'));
const request = {
query: text,
location: new google.maps.LatLng(userLat, userLng),
radius: 2000
};
const results = await new Promise(resolve => {
service.textSearch(request, (res, status) => {
resolve(status === google.maps.places.PlacesServiceStatus.OK ? res || [] : []);
});
});

if (results.length > 0) {
results.sort((a, b) => {
const distA = distanceKm(userLat, userLng, a.geometry.location.lat(), a.geometry.location.lng());
const distB = distanceKm(userLat, userLng, b.geometry.location.lat(), b.geometry.location.lng());
return distA - distB;
});
const closest = results[0];
const dist = distanceKm(userLat, userLng, closest.geometry.location.lat(), closest.geometry.location.lng());
if (dist <= 2) {
const types = closest.types || [];
const lat = closest.geometry.location.lat();
const lng = closest.geometry.location.lng();

if (types.includes('restaurant') || types.includes('food') || types.includes('meal_takeaway') || types.includes('bakery')) {
console.log('‚úÖ Google Maps: Food');
categoryCache[normalized] = 'Food';
saveCache();
return { category: 'Food', lat, lng };
}
if (types.includes('coffee_shop') || types.includes('cafe')) {
console.log('‚úÖ Google Maps: Coffee');
categoryCache[normalized] = 'Coffee';
saveCache();
return { category: 'Coffee', lat, lng };
}
if (types.includes('bar') || types.includes('pub') || types.includes('night_club')) {
console.log('‚úÖ Google Maps: Pints');
categoryCache[normalized] = 'Pints';
saveCache();
return { category: 'Pints', lat, lng };
}
if (types.some(t => ['museum', 'park', 'tourist_attraction'].includes(t))) {
console.log('‚úÖ Google Maps: Places');
categoryCache[normalized] = 'Places';
saveCache();
return { category: 'Places', lat, lng };
}
}
}
} catch (e) {
console.warn('Proximity error:', e);
}
}
// ---- 3. OPENAI CLASSIFICATION ----
console.log('ü§ñ Calling OpenAI for:', text);
const aiCategory = await classifyWithOpenAI(text);
if (aiCategory) {
console.log('‚úÖ OpenAI:', aiCategory);
categoryCache[normalized] = aiCategory;
saveCache();
return aiCategory;
}
// ---- 4. KEYWORD FALLBACK ----
const inputWords = lower.split(/\s+/)
.map(w => w.replace(/s$/, ''))
.filter(w => w.length > 2);
const scores = {};
ALL_CATEGORIES.forEach(c => scores[c] = 0);
for (const word of inputWords) {
for (const [cat, keywords] of Object.entries(FULL_CATEGORIES)) {
if (!keywords) continue;
if (keywords.includes(word)) {
scores[cat] += 1;
}
}
}
let best = 'Other';
let maxScore = 0;
for (const [cat, score] of Object.entries(scores)) {
if (score > maxScore) {
maxScore = score;
best = cat;
}
}
if (maxScore > 0) {
console.log('‚úÖ Keywords:', best);
categoryCache[normalized] = best;
saveCache();
return best;
}
// ---- 5. DEFAULT ----
console.log('‚ùå No match, defaulting to Other');
return 'Other';
}
// === UserProfile Component ===
function UserProfile({ targetUid, onBack, currentUser }) {
const [profileUser, setProfileUser] = useState(null);
const [profileItems, setProfileItems] = useState([]);
const [selectedCategory, setSelectedCategory] = useState('All');
const [loading, setLoading] = useState(true);
useEffect(() => {
let unsubItems;
(async () => {
const userDoc = await db.collection('users').doc(targetUid).get();
if (!userDoc.exists) { setLoading(false); return; }
setProfileUser({ id: userDoc.id, ...userDoc.data() });
unsubItems = db.collection('items')
.where('userId', '==', targetUid)
.where('isPublic', '==', true)
.orderBy('timestamp', 'desc')
.onSnapshot(snap => {
const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
setProfileItems(items);
setLoading(false);
});
})();
return () => unsubItems && unsubItems();
}, [targetUid]);
const filtered = useMemo(() => {
if (selectedCategory === 'All') return profileItems;
return profileItems.filter(i => i.category === selectedCategory);
}, [profileItems, selectedCategory]);
if (loading) return <div className="p-8 text-center">Loading profile‚Ä¶</div>;
if (!profileUser) return <div className="p-8 text-center">User not found</div>;
return (
<div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 pb-6">
<div className="max-w-2xl mx-auto px-4 py-6">
<div className="flex items-center gap-4 mb-6">
<button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-lg">
<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
</button>
<div className="flex-1">
<h2 className="text-2xl font-bold text-gray-800">{profileUser.displayName}</h2>
<p className="text-sm text-gray-500">Public ratings</p>
</div>
</div>
{profileItems.length > 0 && (
<div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
<div className="flex items-center gap-2 mb-3">
<Filter />
<span className="font-semibold text-gray-700">Filter by category:</span>
</div>
<div className="flex flex-wrap gap-2">
{['All', ...ALL_CATEGORIES].map(cat => (
<button key={cat} onClick={() => setSelectedCategory(cat)}
className={`px-4 py-2 rounded-lg font-medium ${selectedCategory === cat ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
{cat}
</button>
))}
</div>
</div>
)}
<div className="space-y-3">
{filtered.length === 0 ? (
<div className="bg-white rounded-2xl shadow-lg p-12 text-center">
<p className="text-gray-500">
{profileItems.length === 0 ? 'No public ratings yet.' : 'No items in this category.'}
</p>
</div>
) : (
filtered.map(item => <ItemCard key={item.id} item={item} view="public" currentUser={currentUser} onVisitProfile={() => {}} />)
)}
</div>
</div>
</div>      
);
}
// === ItemCard ===
function ItemCard({
item, view, currentUser, onVisitProfile, onUpdate, onDelete,
comments, setComments, userLat, userLng
}) {
const [editingComment, setEditingComment] = useState(false);
const [commentText, setCommentText] = useState(item.comment || '');
const [showCategoryPicker, setShowCategoryPicker] = useState(false);
const [editingReply, setEditingReply] = useState(false);
const [replyText, setReplyText] = useState('');
const isOwn = item.userId === currentUser.uid;
// === TOGGLE LIKE/DISLIKE ===
const toggleRating = async () => {
const newRating = item.rating === 'like' ? 'dislike' : 'like';
await db.collection('items').doc(item.id).update({ rating: newRating });
onUpdate({ ...item, rating: newRating });
};
// === TOGGLE PUBLIC/PRIVATE ===
const togglePublic = async () => {
const newPublic = !item.isPublic;
await db.collection('items').doc(item.id).update({ isPublic: newPublic });
onUpdate({ ...item, isPublic: newPublic });
};
// === SAVE COMMENT ===
const saveComment = async () => {
if (commentText.trim() === (item.comment || '')) {
setEditingComment(false);
return;
}
await db.collection('items').doc(item.id).update({
comment: commentText.trim() || null
});
onUpdate({ ...item, comment: commentText.trim() || null });
setEditingComment(false);
};
// === CHANGE CATEGORY ===
const changeCategory = async (newCat) => {
if (newCat === item.category) return;
await db.collection('items').doc(item.id).update({ category: newCat });
onUpdate({ ...item, category: newCat });
setShowCategoryPicker(false);
// === CACHE MANUAL CATEGORIZATION ===
const normalized = normalizeForCache(item.text);
categoryCache[normalized] = newCat;
saveCache();
console.log('üíæ Cached manual categorization:', normalized, '‚Üí', newCat);
};
// === DELETE ITEM ===
const handleDelete = async () => {
await db.collection('items').doc(item.id).delete();
onDelete(item.id);
};
// === SEND REPLY ===
const sendReply = async () => {
const txt = replyText.trim();
if (!txt || txt.length > 120) return;
const payload = {
itemId: item.id,
text: txt,
userId: currentUser.uid,
userName: currentUser.displayName,
createdAt: firebase.firestore.FieldValue.serverTimestamp(),
};
try {
const ref = await db.collection(COMMENTS_COLLECTION).add(payload);
const newComment = {
id: ref.id,
...payload,
createdAt: new Date() // fallback for display
};
setComments(prev => ({
...prev,
[item.id]: [...(prev?.[item.id] || []), newComment]
}));
setReplyText('');
setEditingReply(false);
} catch (error) {
console.error('Failed to add comment:', error);
alert('Failed to post comment. Check console.');
}
};
return (
<div className="bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow">
<div className="flex items-start justify-between">
<div className="flex-1">
<div className="flex items-center gap-2 mb-1 flex-wrap">
{/* LIKE/DISLIKE TOGGLE */}
<button
onClick={isOwn ? toggleRating : undefined}
className={`px-3 py-1 rounded-full text-sm font-semibold border-2 flex items-center gap-1.5 transition-colors
               ${item.rating === 'like'
                 ? 'bg-green-100 text-green-800 border-green-300 hover:bg-green-200'
                 : 'bg-red-100 text-red-800 border-red-300 hover:bg-red-200'
               } ${!isOwn ? 'cursor-default' : 'cursor-pointer'}`}
>
{item.rating === 'like' ? <ThumbsUp /> : <ThumbsDown />}
<span>{item.rating === 'like' ? 'Liked' : 'Disliked'}</span>
</button>
{/* CATEGORY */}
<div className="relative">
<button
onClick={() => isOwn && setShowCategoryPicker(!showCategoryPicker)}
className="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700 flex items-center gap-1 hover:bg-purple-200"
>
{item.category}
</button>
{isOwn && showCategoryPicker && (
<div className="absolute top-full left-0 mt-1 w-40 bg-white rounded-lg shadow-xl border z-10">
{ALL_CATEGORIES.map(cat => (
<button
key={cat}
onClick={() => changeCategory(cat)}
className="block w-full text-left px-3 py-2 text-sm hover:bg-purple-50"
>
{cat}
</button>
))}
</div>
)}
</div>
{/* PUBLIC/PRIVATE TOGGLE */}
<button
onClick={isOwn ? togglePublic : undefined}
className={`px-3 py-1 rounded-full text-xs font-medium flex items-center gap-1 transition-colors
               ${item.isPublic
                 ? 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                 : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
               } ${!isOwn ? 'cursor-default' : 'cursor-pointer'}`}
>
{item.isPublic ? <Globe /> : <Lock />}
<span>{item.isPublic ? 'Public' : 'Private'}</span>
</button>

{/* GEOTAG BADGE */}
{item.geoLat && item.geoLng && (
<a
href={`https://www.google.com/maps/search/?api=1&query=${item.geoLat},${item.geoLng}`}
target="_blank"
rel="noopener noreferrer"
className="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 hover:bg-blue-200 flex items-center gap-1 transition-colors"
title={`View "${item.text}" on map`}
onClick={(e) => e.stopPropagation()} // Prevent card interactions
>
üìç{" "}{distanceKm(userLat || item.geoLat, userLng || item.geoLng, item.geoLat, item.geoLng).toFixed(1)}km
</a>
)}
{/* USER (public feed) */}
{view === 'public' && !isOwn && item.userName && (
<button
onClick={() => onVisitProfile?.(item.userId)}
className="px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600 flex items-center gap-1 hover:bg-gray-200"
>
<Users />
{item.userName}
</button>
)}
{view === 'public' && isOwn && (
<span className="px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700">
You
</span>
)}
</div>
<p className="text-gray-800 font-medium mb-1">{item.text}</p>
<p className="text-sm text-gray-500">{item.date}</p>
{/* COMMENT */}
{item.comment && !editingComment ? (
<div className="mt-2 p-3 bg-gray-50 rounded-lg flex items-start justify-between">
<p className="text-sm text-gray-700 italic flex-1">{item.comment}</p>
{isOwn && (
<button
onClick={() => setEditingComment(true)}
className="ml-2 text-xs text-purple-600 hover:underline"
>
Edit
</button>
)}
</div>
) : editingComment ? (
<div className="mt-2 flex gap-1 items-center">
<input
type="text"
value={commentText}
onChange={e => setCommentText(e.target.value)}
placeholder="Add a comment..."
className="flex-1 px-3 py-1.5 text-sm border rounded-lg focus:outline-none focus:border-purple-400"
autoFocus
/>
<button onClick={saveComment} className="text-green-600 text-xs font-medium">Save</button>
<button
onClick={() => {
setEditingComment(false);
setCommentText(item.comment || '');
}}
className="text-red-600 text-xs"
>
Cancel
</button>
</div>
) : isOwn && !item.isPublic && (
<button
onClick={() => setEditingComment(true)}
className="mt-2 text-xs text-purple-600 hover:underline"
>
Add comment
</button>
)}
</div>
{/* DELETE */}
{isOwn && (
<button
onClick={handleDelete}
className="ml-3 p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
>
<Trash2 />
</button>
)}
</div>
{/* === PUBLIC COMMENTS SECTION === */}
{item.isPublic && (
<div className="mt-4 border-t pt-3">
{/* Comment List */}
<div className="space-y-2 mb-3">
{(comments?.[item.id] || []).map(c => {
const isOwnComment = c.userId === currentUser.uid;
const handleDeleteComment = async () => {
try {
await db.collection(COMMENTS_COLLECTION).doc(c.id).delete();
setComments(prev => ({
...prev,
[item.id]: prev[item.id]?.filter(cm => cm.id !== c.id) || []
}));
} catch (error) {
console.error('Delete failed:', error);
alert('Oops, delete failed‚Äîtry again?');
}
};
return (
<div key={c.id} className="flex items-start gap-2 text-sm relative group">
<div className="font-medium text-purple-700">{c.userName}:</div>
<div className="text-gray-700 flex-1">{c.text}</div>
<div className="text-xs text-gray-400 ml-auto">
{c.createdAt ? new Date(c.createdAt.toDate?.() || c.createdAt).toLocaleString() : 'Just now'}
</div>
{isOwnComment && (
<button
onClick={handleDeleteComment}
className="absolute -top-1 -right-1 p-1 text-gray-300 hover:text-red-600 rounded-full hover:bg-red-50 opacity-0 group-hover:opacity-100 transition-opacity ml-2"
title="Delete comment"
>
<Trash2 width="12" height="12" />
</button>
)}
</div>
);
})}
{(!comments?.[item.id] || comments[item.id]?.length === 0) && (
<p className="text-xs text-gray-500 italic">No comments yet</p>
)}
</div>
{/* Add comment trigger */}
{editingReply ? (
<div className="flex gap-1.5 items-center mt-2">
<input
type="text"
value={replyText}
onChange={e => setReplyText(e.target.value)}
onKeyDown={e => e.key === 'Enter' && sendReply()}
placeholder="Reply..."
className="flex-1 px-2 py-1 text-sm border rounded-md focus:outline-none focus:border-purple-400"
autoFocus
/>
<button
onClick={sendReply}
className="text-xs font-medium text-purple-600 hover:underline"
>
Send
</button>
<button
onClick={() => {
setEditingReply(false);
setReplyText('');
}}
className="text-xs text-gray-500"
>
Cancel
</button>
</div>
) : (
<button
onClick={() => setEditingReply(true)}
className="text-xs text-purple-600 hover:underline mt-1"
>
Add comment
</button>
)}
</div>
)}
</div>
);
}

// === MAIN APP ===
function BinaryApp() {
const [user, setUser] = useState(null);
const [userLat, setUserLat] = useState(null);  // NEW
const [userLng, setUserLng] = useState(null);  // NEW
const [items, setItems] = useState([]);
const [publicItems, setPublicItems] = useState([]);
const [following, setFollowing] = useState([]);
const [view, setView] = useState('my');
const [profileTarget, setProfileTarget] = useState(null);
const [selectedCategory, setSelectedCategory] = useState('All');
const [inputText, setInputText] = useState('');
const [isProcessing, setIsProcessing] = useState(false);
const [isLoading, setIsLoading] = useState(true);
const [showUserSearch, setShowUserSearch] = useState(false);
const [searchQuery, setSearchQuery] = useState('');
const [searchResults, setSearchResults] = useState([]);
// === infinte scroll ===
const [hasMore, setHasMore] = useState(true);  // True if more items to load
const [lastDoc, setLastDoc] = useState(null);  // "Bookmark" for next page
const [loadingMore, setLoadingMore] = useState(false);  // Spinner flag
// === SWIPE GESTURE STATES ===
const [touchStart, setTouchStart] = useState(null);
const [touchEnd, setTouchEnd] = useState(null);
const minSwipeDistance = 80; // pixels

// === UI FEEDBACK & COMMENTS ===
const [message, setMessage] = useState(null);  // { itemId: "text" }
const [comments, setComments] = useState({});           // { itemId: [{‚Ä¶}] }
// Demo mode (public profile view)
const urlParams = new URLSearchParams(window.location.search);
const demoUid = urlParams.get('demo');
const demoCategory = urlParams.get('category') || 'Books';
const [isDemoMode, setIsDemoMode] = useState(!!demoUid);
const [demoUser, setDemoUser] = useState(null);
// === SWIPE HANDLERS ===
const onTouchStart = (e) => {
setTouchEnd(null);
setTouchStart(e.targetTouches[0].clientX);
};
const onTouchMove = (e) => {
setTouchEnd(e.targetTouches[0].clientX);
};
const onTouchEnd = () => {
if (!touchStart || !touchEnd) return;
const distance = touchStart - touchEnd;
const isLeftSwipe = distance > minSwipeDistance;
const isRightSwipe = distance < -minSwipeDistance;
if (isLeftSwipe && view === 'my') setView('public');
if (isRightSwipe && view === 'public') setView('my');
setTouchStart(null);
setTouchEnd(null);
};
const showMessage = (txt, type = 'success') => {
setMessage({ txt, type });
setTimeout(() => setMessage(null), 3000);
};

// === NEW: Load comments for a list of items ===
const loadComments = async (itemList) => {
const itemIds = itemList.map(i => i.id);
if (!itemIds.length) return;

const batches = [];
for (let i = 0; i < itemIds.length; i += 30) {
const batch = itemIds.slice(i, i + 30);
const snap = await db.collection(COMMENTS_COLLECTION)
.where('itemId', 'in', batch)
.orderBy('createdAt', 'asc')
.get();

const map = {};
snap.docs.forEach(d => {
const c = { id: d.id, ...d.data() };
const arr = map[c.itemId] || [];
arr.push(c);
map[c.itemId] = arr;
});
setComments(prev => ({ ...prev, ...map }));
}
};
const signOut = async () => {
try {
await auth.signOut();
setItems([]);
setPublicItems([]);
setFollowing([]);
setView('my');
showMessage('Signed out');
} catch (error) {
console.error('Sign out error:', error);
}
};
// Helper to save user data
const saveUserToFirestore = async (user) => {
await db.collection('users').doc(user.uid).set({
displayName: user.displayName,
email: user.email,
photoURL: user.photoURL,
lastLogin: firebase.firestore.FieldValue.serverTimestamp()
}, { merge: true });
};
// ---------------------------------------------------------------
//  Base-64 padding fix ‚Äì put this right after the other helpers
// ---------------------------------------------------------------
function fixBase64(str) {
  if (!str) return str;
  str = str.replace(/-/g, '+').replace(/_/g, '/');
  switch (str.length % 4) {
    case 2: str += '=='; break;
    case 3: str += '=';  break;
  }
  return str;
}
//  NEW signInWithGoogle ‚Äì replace the old one (starts ~ line 380)
// ------------------------------------------------------------------
const signInWithGoogle = async () => {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    // ---------- iOS PWA (standalone) ‚Äì use custom popup ----------
    if (isIOS && isInStandaloneMode()) {
      const popup = window.open(
        `${AUTH_WORKER_URL}/auth/google`,
        'googleAuth',
        'width=500,height=600,left=100,top=100'
      );

      return new Promise((resolve, reject) => {
        const handler = async (e) => {
          if (e.origin !== AUTH_WORKER_URL) return;
          if (e.data.type !== 'FIREBASE_AUTH') return;

          window.removeEventListener('message', handler);

          try {
            // ---- 1. Fix Base64 padding (defensive) ----
            const rawToken = e.data.token;
            const token = fixBase64(rawToken);

            // ---- 2. Log for debugging (remove in prod if you want) ----
            console.log('Raw token:', rawToken);
            console.log('Fixed token length:', token.length);

            // ---- 3. Create credential with **only** the ID token ----
            const credential = firebase.auth.GoogleAuthProvider.credential(token);

            const result = await auth.signInWithCredential(credential);
            await saveUserToFirestore(result.user);
            showMessage('Signed in!');
            resolve(result);
          } catch (err) {
            console.error('Auth failed:', err);
            showMessage('Login failed: ' + err.message, 'error');
            reject(err);
          }
        };
        window.addEventListener('message', handler);
      });
    }
    
    // iOS Safari / Android / Desktop
    const result = await auth.signInWithPopup(provider);
    await saveUserToFirestore(result.user);
    showMessage('Signed in!');
    return result;

  } catch (error) {
    console.error('Sign-in error:', error);
    showMessage('Sign-in failed', 'error');
  }
};
// Auth observer with redirect handling
useEffect(() => {
const unsub = auth.onAuthStateChanged(async (u) => {
console.log('Auth state changed:', u?.uid || 'logged out');
setUser(u);

if (u) {
  // Cancel any demo loading
  window.demoAbortController?.abort();
  setIsDemoMode(false);
  setPublicItems([]);
  setDemoUser(null);
  await Promise.all([loadMyItems(u.uid), loadFollowing(u.uid)]);
}

setIsLoading(false);
});
return () => unsub();
}, []);
// Public feed reload with reset
useEffect(() => {
if (view === 'public' && user) {
setHasMore(true);
setLastDoc(null);
setPublicItems([]); // Clear for fresh load
loadPublicFeed();
}
}, [view, following, user]);
// Search users automatically when typing
useEffect(() => {
  const timeout = setTimeout(() => {
    searchUsers(searchQuery);
  }, 300); // 300ms debounce

  return () => clearTimeout(timeout);
}, [searchQuery, following, user]);
// Infinite scroll observer
useEffect(() => {
if (view !== 'public' || !hasMore || publicItems.length === 0 || loadingMore || isDemoMode || !user) return;
const observer = new IntersectionObserver(
([entry]) => {
if (entry.isIntersecting) {
loadPublicFeed(lastDoc);
}
},
{ threshold: 0.1 }
);
const lastItemEl = document.querySelector('.space-y-3 > *:last-child');
if (lastItemEl) observer.observe(lastItemEl);
return () => observer.disconnect();
}, [publicItems, lastDoc, hasMore, loadingMore, view, user, isDemoMode]); 
// 1Ô∏è‚É£  Get location once
useEffect(() => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        setUserLat(pos.coords.latitude);
        setUserLng(pos.coords.longitude);
      },
      err => console.warn('Location unavailable:', err),
      { maximumAge: 300000 }
    );
  }
}, []);

// 2Ô∏è‚É£  Auto-load demo if ?demo=uid&category=books
useEffect(() => {
  if (demoUid && !user) {
    loadDemoProfile(demoUid, demoCategory);
    setView('public');
    setSelectedCategory(demoCategory);
  }
}, [demoUid, demoCategory, user]);

// 3Ô∏è‚É£  Cancel demo when user logs in
useEffect(() => {
  if (user && isDemoMode) {
    window.demoAbortController?.abort();
    setIsDemoMode(false);
  }
}, [user, isDemoMode]);  // ‚úÖ end here ‚Äî nothing after this
//public feed
const loadPublicFeed = async (startAfterDoc = null) => {
if (loadingMore && startAfterDoc) return; // Don't double-load
if (!user) {
      setLoadingMore(false); // Ensure loading spinner is turned off
      return;
}
setLoadingMore(true);
const uids = [user.uid, ...following]; // Your users (self + follows)
if (!uids.length) {
setPublicItems([]);
setLoadingMore(false);
setHasMore(false);
return;
}
let allNewItems = []; // Collect items from batches
for (let i = 0; i < uids.length; i += 10) { // Batch UIDs (Firestore limit)
const batch = uids.slice(i, i + 10);
let query = db.collection('items')
.where('userId', 'in', batch)
.where('isPublic', '==', true)
.orderBy('timestamp', 'desc')
.limit(20); // 20 per batch
if (startAfterDoc) {
query = query.startAfter(startAfterDoc); // Next page magic!
}
const snap = await query.get();
if (snap.empty && startAfterDoc) {
setHasMore(false); // No more!
break;
}
const items = await Promise.all(
snap.docs.map(async doc => {
const data = doc.data();
const uDoc = await db.collection('users').doc(data.userId).get();
const u = uDoc.data() || {};
return {
id: doc.id,
...data,
userName: u.displayName || 'Anonymous',
isOwnItem: data.userId === user.uid
};
})
);
allNewItems.push(...items);
}
// Sort newest first
allNewItems.sort((a, b) => b.timestamp - a.timestamp);
// Add to state: Replace if first load, append if more
setPublicItems(prev => startAfterDoc ? [...prev, ...allNewItems] : allNewItems);
// Update bookmark & comments
if (allNewItems.length > 0 && snap?.docs?.length > 0) {  // Safe check for snap
setLastDoc(snap.docs[snap.docs.length - 1]); // Last item as next start
} else {
setHasMore(false);
}
await loadComments(startAfterDoc ? [...publicItems, ...allNewItems] : allNewItems); // Load comments for new ones
setLoadingMore(false);
};
const loadMyItems = async uid => {
const snap = await db.collection('items').where('userId', '==', uid).orderBy('timestamp', 'desc').get();
setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })));
loadComments(snap.docs.map(d => ({ id: d.id, ...d.data() })));
};
const loadFollowing = async uid => {
const snap = await db.collection('follows').where('followerId', '==', uid).get();
setFollowing(snap.docs.map(d => d.data().followingId));
};
// Load demo profile (public items for non-auth user)
const loadDemoProfile = async (uid, category) => {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout

  try {
    const userDoc = await db.collection('users').doc(uid).get();
    if (!userDoc.exists || controller.signal.aborted) return;
    setDemoUser({ id: uid, ...userDoc.data() });

    const snap = await db.collection('items')
      .where('userId', '==', uid)
      .where('isPublic', '==', true)
      .where('category', '==', category)
      .orderBy('timestamp', 'desc')
      .get();

    if (controller.signal.aborted) return;

    const items = snap.docs.map(d => ({ 
      id: d.id, 
      ...d.data(), 
      userName: userDoc.data().displayName 
    }));
    
    setPublicItems(items);
    //await loadComments(items);// not enabled if not logged in
  } catch (err) {
    if (err.name === 'AbortError') return;
    console.error('Demo load error:', err);
  } finally {
    clearTimeout(timeout);
  }

  // Store controller to cancel later
  window.demoAbortController = controller;
};
const searchUsers = async q => {
  if (!q.trim()) {
    setSearchResults([]);
    return;
  }
  const lower = q.toLowerCase();
  const snap = await db.collection('users').get();
  const all = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(u => u.id !== user?.uid)
    .filter(u => 
      u.displayName?.toLowerCase().includes(lower) || 
      u.email?.toLowerCase().includes(lower)
    ); 
  // Sort: followed first, then others
  const followed = all.filter(u => following.includes(u.id));
  const others = all.filter(u => !following.includes(u.id));
  setSearchResults([...followed, ...others]);
};
const followUser = async targetId => {
if (following.includes(targetId)) return showMessage('Already following');
await db.collection('follows').doc(`${user.uid}_follows_${targetId}`).set({
followerId: user.uid,
followingId: targetId,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
});
setFollowing([...following, targetId]);
showMessage('Now following');
};
const unfollowUser = async targetId => {
await db.collection('follows').doc(`${user.uid}_follows_${targetId}`).delete();
setFollowing(following.filter(id => id !== targetId));
showMessage('Unfollowed');
if (view === 'public') loadPublicFeed(null);  // Updated: Pass null for fresh load
};
const addItem = async rating => {
if (!inputText.trim() || isProcessing) return;
setIsProcessing(true);
try {
let userLat = null, userLng = null;
if (navigator.geolocation) {
try {
const position = await new Promise((resolve, reject) => {
navigator.geolocation.getCurrentPosition(resolve, reject, {
timeout: 5000,
maximumAge: 60000
});
});
userLat = position.coords.latitude;
userLng = position.coords.longitude;
} catch (geoError) {
console.warn('Location unavailable:', geoError);
}
}
const result = await detectCategory(inputText, userLat, userLng);
const cat = typeof result === 'string' ? result : result.category;
console.log('üìä CATEGORIZATION RESULT:', { input: inputText, result, finalCategory: cat, method: typeof result === 'object' ? 'Google Maps' : result === categoryCache[normalizeForCache(inputText)] ? 'Cache' : 'AI/Keywords' });
const geoLat = typeof result === 'object' ? result.lat : null;
const geoLng = typeof result === 'object' ? result.lng : null;
const payload = {
text: inputText.trim(),
rating,
category: cat,
timestamp: Date.now(),
date: new Date().toLocaleDateString(),
userId: user.uid,
isPublic: true,
geoLat,  // NEW
geoLng   // NEW
};
const ref = await db.collection('items').add({ ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
setItems(prev => [{ id: ref.id, ...payload }, ...prev]);
setInputText('');
showMessage('Added!');
} catch (e) { 
console.error(e); 
showMessage('Error adding item', 'error'); 
} finally { 
setIsProcessing(false); 
}
};
const deleteItem = async id => {
await db.collection('items').doc(id).delete();
setItems(prev => prev.filter(i => i.id !== id));
showMessage('Deleted');
};
const togglePublic = async (id, cur) => {
await db.collection('items').doc(id).update({ isPublic: !cur });
setItems(prev => prev.map(i => i.id === id ? { ...i, isPublic: !cur } : i));
showMessage(cur ? 'Now private' : 'Now public');
};
const visitProfile = uid => {
if (!following.includes(uid)) {
showMessage('Follow this user first to view their page', 'error');
return;
}
setView('profile');
setProfileTarget(uid);
};
const backFromProfile = () => {
setView('public');
setProfileTarget(null);
};
const currentItems = view === 'my' ? items : view === 'public' ? publicItems : [];
const filteredItems = useMemo(() => {
if (selectedCategory === 'All') return currentItems;
return currentItems.filter(i => i.category === selectedCategory);
}, [currentItems, selectedCategory]);
// === DEMO MODE: Public profile view (no login) ===
if (isDemoMode && !user) {
  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 pb-6">
      <div className="max-w-2xl mx-auto px-4 py-6">
        {/* Demo Banner */}
        <div className="bg-purple-100 border-l-4 border-purple-500 p-4 mb-6 rounded-r-lg">
          <p className="text-purple-800 font-semibold">Demo: {demoUser?.displayName || "Yvonne's"} Book Ratings</p>
          <p className="text-sm text-purple-700 mt-1">Public view ‚Äî <a href="https://yvonnebuttle.github.io/binary/" className="underline">Try the full app</a></p>
        </div>
        
        <div className="text-center mb-6">
          <h1 className="text-3xl font-bold text-gray-800">Binary Books</h1>
          <p className="text-gray-600">What I've liked/disliked</p>
        </div>
        
        <div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
          <span className="font-semibold text-gray-700">Category: Books</span>
        </div>
        
        <div className="space-y-3">
          {publicItems.length === 0 ? (
            <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
              <p className="text-gray-500">Loading books...</p>
            </div>
          ) : (
            publicItems.map(itm => (
              <div key={itm.id} className="bg-white rounded-xl shadow-md p-4">
                <div className="flex items-center gap-2 mb-2">
                  <span className={`px-3 py-1 rounded-full text-sm font-semibold ${itm.rating === 'like' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                    {itm.rating === 'like' ? <ThumbsUp /> : <ThumbsDown />} {itm.rating}
                  </span>
                  <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">Books</span>
                  <span className="text-sm text-gray-600 ml-auto">{itm.date}</span>
                </div>
                <p className="text-gray-800 font-medium">{itm.text}</p>
                {itm.comment && <p className="text-sm text-gray-500 italic mt-1">"{itm.comment}"</p>}
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
}

// === NORMAL LOGIN SCREEN (unchanged) ===
if (!user && !isDemoMode) {
  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 flex items-center justify-center px-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
        <h1 className="text-4xl font-bold text-gray-800 mb-2">Binary</h1>
        <p className="text-gray-600 mb-8">Yes/no, that's all</p>
        <button 
          onClick={signInWithGoogle}
          className="w-full bg-white border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-xl flex items-center justify-center gap-3 transition-all hover:shadow-md"
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>
        {isIOS && (
          <p className="text-xs text-gray-500 mt-4">
            iOS users: If sign-in doesn't work, try allowing popups in Safari settings.
          </p>
        )}
        <div className="mt-6 pt-6 border-t border-gray-200">
          <a href="https://yvonnebuttle.github.io/binary/privacy.html" target="_blank" rel="noopener noreferrer" className="text-sm text-gray-500 hover:text-purple-600">
            Privacy Policy
          </a>
        </div>
      </div>
    </div>
  );
}
if (isLoading) return <div className="min-h-screen flex items-center justify-center">Loading‚Ä¶</div>;
if (view === 'profile' && profileTarget) {
return <UserProfile targetUid={profileTarget} onBack={backFromProfile} currentUser={user} />;
}
return (
<div className="min-h-screen bg-gradient-to-br from-purple-50 to-blue-50 pb-6">
<div 
className="max-w-2xl mx-auto px-4 py-6"
onTouchStart={onTouchStart}
onTouchMove={onTouchMove}
onTouchEnd={onTouchEnd}
>
{message && (
<div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium ${message.type === 'error' ? 'bg-red-500' : 'bg-green-500'}`}>
{message.txt}
</div>
)}

{/* Search Modal */}
{showUserSearch && (
<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
<div className="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col">
<div className="p-6 border-b flex items-center justify-between">
<h2 className="text-2xl font-bold text-gray-800">Find Users</h2>
<button onClick={() => { setShowUserSearch(false); setSearchQuery(''); setSearchResults([]); }} className="p-2 hover:bg-gray-100 rounded-lg"><X /></button>
</div>
<div className="p-6">
<div className="relative">
<Search className="absolute left-3 top-3 text-gray-400" />
<input type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Search by name‚Ä¶" className="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:outline-none" autoFocus />
</div>
</div>
<div className="flex-1 overflow-y-auto px-6 pb-6">
{searchResults.length === 0 && searchQuery && <p className="text-center text-gray-500 py-8">No users found</p>}
{searchResults.length === 0 && !searchQuery && <p className="text-center text-gray-500 py-8">Start typing‚Ä¶</p>}
<div className="space-y-3">
{searchResults.map(u => (
  <div key={u.id} className="bg-gray-50 rounded-xl p-4 flex items-center justify-between">
    <div className="flex items-center gap-2">
      {following.includes(u.id) ? (
        <button
          onClick={() => {
            setShowUserSearch(false);
            setView('profile');
            setProfileTarget(u.id);
          }}
          className="font-semibold text-purple-700 hover:text-purple-900 hover:underline"
        >
          {u.displayName}
        </button>
      ) : (
        <span className="font-semibold text-gray-800">{u.displayName}</span>
      )}
      {following.includes(u.id) && (
        <span className="px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-700 rounded-full">
          Following
        </span>
      )}
    </div>
    {following.includes(u.id) ? (
      <button
        onClick={() => unfollowUser(u.id)}
        className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium flex items-center gap-2"
      >
        <UserMinus /> Unfollow
      </button>
    ) : (
      <button
        onClick={() => followUser(u.id)}
        className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium flex items-center gap-2"
      >
        <UserPlus /> Follow
      </button>
    )}
  </div>
))}
</div>
</div>
</div>
</div>
)}
{/* Header */}
<div className="text-center mb-6">
<div className="flex items-center justify-between mb-2">
<button onClick={() => setShowUserSearch(true)} className="p-2 text-purple-600 hover:bg-purple-50 rounded-lg"><Search /></button>
<h1 className="text-3xl font-bold text-gray-800">Binary</h1>
<button onClick={signOut} className="p-2 text-gray-600 hover:text-red-500 hover:bg-red-50 rounded-lg"><LogOut /></button>
</div>
<p className="text-gray-600">Welcome, {user.displayName}!</p>
</div>
{/* View Toggle */}
<div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
<div className="flex gap-2">
<button onClick={() => setView('my')} className={`flex-1 py-3 px-4 rounded-xl font-semibold flex items-center justify-center gap-2 ${view === 'my' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
<Lock /> My Items ({items.length})
</button>
<button onClick={() => setView('public')} className={`flex-1 py-3 px-4 rounded-xl font-semibold flex items-center justify-center gap-2 ${view === 'public' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
<Globe /> Feed
</button>
</div>
</div>
{/* Input */}
{view === 'my' && (
<div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
<input
type="text"
value={inputText}
onChange={e => {
const val = e.target.value;
if (val.length <= 500) setInputText(val);
}}
placeholder="What did you experience?"
className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-400 focus:outline-none mb-4"
disabled={isProcessing}
/>
<div className="flex gap-3">
<button
onClick={() => addItem('like')}
disabled={!inputText.trim() || isProcessing}
className="flex-1 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2"
>
<ThumbsUp />
{isProcessing ? '‚Ä¶' : 'Like'}
</button>
<button
onClick={() => addItem('dislike')}
disabled={!inputText.trim() || isProcessing}
className="flex-1 bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2"
>
<ThumbsDown />
{isProcessing ? '‚Ä¶' : 'Dislike'}
</button>
</div>
</div>
)}
{/* Filter */}
{currentItems.length > 0 && (
<div className="bg-white rounded-2xl shadow-lg p-4 mb-6">
<div className="flex items-center gap-2 mb-3">
<Filter />
<span className="font-semibold text-gray-700">Filter by category:</span>
</div>
<div className="flex flex-wrap gap-2">
{['All', ...ALL_CATEGORIES].map(c => (
<button key={c} onClick={() => setSelectedCategory(c)} className={`px-4 py-2 rounded-lg font-medium ${selectedCategory === c ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
{c}
</button>
))}
</div>
</div>
)}
{/* Items list */}
<div className="space-y-3">
{filteredItems.length === 0 ? (
<div className="bg-white rounded-2xl shadow-lg p-12 text-center">
<p className="text-gray-500">
{view === 'public'
? following.length === 0
? 'Follow users to see their ratings!'
: 'No public items yet'
: items.length === 0
? 'Start rating!'
: 'No items in this category'}
</p>
{view === 'public' && following.length === 0 && (
<button
onClick={() => setShowUserSearch(true)}
className="mt-4 px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-semibold flex items-center gap-2 mx-auto"
>
<Search /> Find Users
</button>
)}
</div>
) : (
filteredItems.map(itm => {
const handleUpdate = updatedItem => {
if (view === 'my') {
setItems(prev => prev.map(i => (i.id === updatedItem.id ? updatedItem : i)));
} else {
setPublicItems(prev => prev.map(i => (i.id === updatedItem.id ? updatedItem : i)));
}
};
const handleDelete = id => {
if (view === 'my') {
setItems(prev => prev.filter(i => i.id !== id));
} else {
setPublicItems(prev => prev.filter(i => i.id !== id));
}
};
return (
<ItemCard
key={itm.id}
item={itm}
view={view}
currentUser={user}
userLat={userLat} // NEW
userLng={userLng} // NEW
onVisitProfile={visitProfile}
onUpdate={handleUpdate}
onDelete={handleDelete}
comments={comments}
setComments={setComments}
/>
);
})
)}
</div>
{/* Stats */}
{view === 'my' && items.length > 0 && (
<div className="mt-6 bg-white rounded-2xl shadow-lg p-6">
<h3 className="font-bold text-gray-800 mb-3">Your Stats</h3>
<div className="grid grid-cols-2 gap-4">
<div className="text-center p-4 bg-green-50 rounded-xl">
<div className="text-3xl font-bold text-green-600">{items.filter(i => i.rating === 'like').length}</div>
<div className="text-sm text-gray-600">Liked</div>
</div>
<div className="text-center p-4 bg-red-50 rounded-xl">
<div className="text-3xl font-bold text-red-600">{items.filter(i => i.rating === 'dislike').length}</div>
<div className="text-sm text-gray-600">Disliked</div>
</div>
</div>
</div>
)}
{/*main page footer*/}
<div className="mt-8 text-center pb-4">
<a href="https://yvonnebuttle.github.io/binary/privacy.html" target="_blank" rel="noopener noreferrer" className="text-sm text-gray-500 hover:text-purple-600">
Privacy Policy
</a>
{' | '}
<a
href={`mailto:yvonnebuttle1@gmail.com?subject=Binary%20App%20Bug%20-%20${navigator.userAgent}&body=Hi!%20I%20found%20a%20bug%20on%20${new Date().toLocaleDateString()}.%0A%0ADescribe%20it%20here:%0A%0ASteps:%201.%20...%202.%20...%0A%0ADevice/Browser:%20${navigator.userAgent.substring(0, 100)}`}  // Swap email!
className="text-sm text-gray-500 hover:text-purple-600"
>
Report Bug
</a>
</div>
</div>
</div>
);
}
// Simple Error Boundary (wraps the app to catch render errors) ACTUALLY new
class ErrorBoundary extends React.Component {
constructor(props) {
super(props);
this.state = { hasError: false, error: null };
}
static getDerivedStateFromError(error) {
return { hasError: true, error };
}
componentDidCatch(error, errorInfo) {
console.error('App render error:', error, errorInfo);
}
render() {
if (this.state.hasError) {
return (
<div className="min-h-screen flex items-center justify-center bg-red-50">
<div className="text-center p-8 bg-white rounded-lg shadow">
<h2 className="text-red-600 mb-4">Oops! Something broke.</h2>
<p className="text-gray-600 mb-4">Error: {this.state.error?.message || 'Unknown'}</p>
<button onClick={() => window.location.reload()} className="bg-red-500 text-white px-4 py-2 rounded">Reload App</button>
</div>
</div>
);
}
return this.props.children;
}
}
// Render App (react 18)
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
<ErrorBoundary>
<BinaryApp />
</ErrorBoundary>
);
console.log('App mounted!');
</script>
</body>
</html>
