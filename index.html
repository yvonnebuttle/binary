<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Binary">
    <title>Binary</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBNjg2ZqtsUmoXcMq-guhJAPwY9lIUNPkI&libraries=places" async defer></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="root"></div>
    
<script type="text/babel">
const { useState, useEffect } = React;

// === Firebase Configuration ===
// TODO: Replace with your Firebase project credentials
const firebaseConfig = {

     apiKey: "AIzaSyBd6y1rHm7X2u-T1f6PiAmB7lZD9N_5IGc",

     authDomain: "binary-97277.firebaseapp.com",

     projectId: "binary-97277",

     storageBucket: "binary-97277.firebasestorage.app",

     messagingSenderId: "394721532495",

     appId: "1:394721532495:web:e0b9265dd19fd36e15283a"

   };

// Initialize Firebase
let auth, db;
try {
  firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  
  // Set auth persistence to LOCAL (stays logged in)
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
    .catch(error => console.error("Persistence error:", error));
} catch (error) {
  console.error("Firebase initialization error:", error);
}

// === SVG icons ===
const ThumbsUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></svg>;
const ThumbsDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"/></svg>;
const Filter = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
const MessageSquare = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
const Users = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
const LogOut = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
const Globe = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>;
const Lock = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
const Search = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
const UserPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>;
const UserMinus = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="22" x2="16" y1="11" y2="11"/></svg>;

// === Master category list ===
const ALL_CATEGORIES = [
  'Food', 'Coffee', 'Beverages', 'Places', 'Books', 'Movies',
  'Cheese', 'Dates', 'People', 'Sports', 'Entertainment', 'Things', 'Other'
];

// Cache for category detection
let categoryCache = {};
try {
  const storedCache = localStorage.getItem("categoryCache");
  if (storedCache) categoryCache = JSON.parse(storedCache);
} catch(err){ console.warn(err); }

function saveCache() {
  try { localStorage.setItem("categoryCache", JSON.stringify(categoryCache)); }
  catch(err){ console.warn(err); }
}

// Enhanced keyword patterns
const CATEGORY_KEYWORDS = {
  Cheese: {
    exact: ["cheese","cheddar","brie","gouda","mozzarella","parmesan","feta","camembert","gruyere","manchego","pecorino","ricotta","stilton","roquefort","gorgonzola","emmental","havarti","provolone"],
    score: 0.8
  },
  Coffee: {
    exact: ["coffee","cafe","latte","espresso","cappuccino","americano","macchiato","mocha","flat white","cortado","affogato"],
    partial: ["starbucks","costa","cafe nero","pret"],
    score: 0.7
  },
  Beverages: {
    exact: ["bar","pub","cocktail","brewery","beer","wine","gin","vodka","whiskey","rum","tequila","ale","lager","cider","spirits","champagne","prosecco"],
    partial: ["taproom","brewpub","tavern","lounge"],
    score: 0.7
  },
  Food: {
    exact: ["restaurant","ramen","pizza","burger","pasta","sushi","taco","curry","noodles","sandwich","steak","chicken","seafood","bakery","diner","bistro"],
    partial: ["cuisine","eatery","grill","kitchen"],
    score: 0.6
  },
  Places: {
    exact: ["museum","park","beach","monument","gallery","plaza","square","garden","island","mountain","lake","resort","castle","palace","temple","cathedral"],
    partial: ["tourist","attraction","landmark","historic"],
    score: 0.5
  },
  Books: {
    exact: ["novel","memoir","biography","poetry","textbook"],
    partial: ["author","reading","literature"],
    score: 0.6
  },
  Movies: {
    exact: ["film","cinema","documentary","series","episode"],
    partial: ["actor","director","netflix","disney"],
    score: 0.5
  },
  Things: {
    exact: ["shoes","bike","sneakers","jacket","laptop","bag","phone","watch","headphones","camera","tablet","keyboard","backpack","suitcase","umbrella"],
    score: 0.6
  },
  Sports: {
    exact: ["football","soccer","basketball","tennis","cricket","rugby","baseball","hockey","golf","swimming","match","championship","tournament","surfing","skiing","snowboarding","skateboarding","climbing","hiking","running","cycling","yoga","pilates","boxing","wrestling","martial arts","karate","judo","gymnastics","athletics","track","field"],
    score: 0.7
  },
  Dates: {
    exact: ["date","dating","romantic","anniversary","valentine","proposal","engagement","wedding","relationship","boyfriend","girlfriend","partner","spouse"],
    score: 0.7
  },
  People: {
    exact: ["person","friend","colleague","coworker","manager","boss","teacher","professor","doctor","nurse","artist","musician","celebrity","politician","athlete","neighbor","roommate","classmate"],
    score: 0.6
  },
  Entertainment: {
    exact: ["concert","festival","show","performance","theater","theatre","comedy","stand-up","magic","circus","exhibition","gig","club","nightclub","disco","rave","party","event"],
    score: 0.6
  }
};

function waitForGoogleMaps() {
  return new Promise(resolve => {
    if (window.google && window.google.maps) return resolve();
    const interval = setInterval(() => {
      if (window.google && window.google.maps) {
        clearInterval(interval);
        resolve();
      }
    }, 100);
  });
}

function distanceKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

async function detectCategory(inputText, userLat, userLng) {
  const text = inputText.trim();
  if (!text) return 'Other';
  const lower = text.toLowerCase();
  if (categoryCache[text]) return categoryCache[text];

  const scores = {};
  ALL_CATEGORIES.forEach(cat => scores[cat] = 0);

  for (const [category, config] of Object.entries(CATEGORY_KEYWORDS)) {
    if (config.exact?.some(k => lower.includes(k))) {
      scores[category] = Math.max(scores[category], config.score);
    }
    if (config.partial?.some(k => lower.includes(k))) {
      scores[category] = Math.max(scores[category], config.score * 0.7);
    }
  }

  try {
    const bookRes = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(text)}&maxResults=5`);
    const bookData = await bookRes.json();
    if (bookData.items?.length) {
      const bestMatch = bookData.items[0];
      const title = bestMatch.volumeInfo.title?.toLowerCase() || '';
      const titleMatch = title === lower || title.includes(lower);
      const ratingCount = bestMatch.volumeInfo.ratingsCount || 0;
      const avgRating = bestMatch.volumeInfo.averageRating || 0;
      const popularity = Math.min((ratingCount / 100) * avgRating, 10) / 10;
      if (titleMatch) {
        scores.Books = Math.max(scores.Books, 0.7 + (popularity * 0.2));
      } else if (bookData.items.length >= 3) {
        scores.Books = Math.max(scores.Books, 0.4 + (popularity * 0.1));
      }
    }
  } catch(err){ console.warn("Books API failed:", err); }

  try {
    const tmdbKey = '559458ec6b7148bf5d8a39f7224a2fb8';
    const movieRes = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${tmdbKey}&query=${encodeURIComponent(text)}`);
    const movieData = await movieRes.json();
    if (movieData.results?.length) {
      const bestMatch = movieData.results[0];
      const title = bestMatch.title?.toLowerCase() || '';
      const titleMatch = title === lower || title.includes(lower);
      const popularity = Math.min(bestMatch.popularity / 100, 1);
      if (titleMatch) {
        scores.Movies = Math.max(scores.Movies, 0.6 + (popularity * 0.2));
      } else if (movieData.results.length >= 3) {
        scores.Movies = Math.max(scores.Movies, 0.35 + (popularity * 0.1));
      }
    }
  } catch(err){ console.warn("Movies API failed:", err); }

  try {
    await waitForGoogleMaps();
    if (window.google?.maps) {
      const service = new google.maps.places.AutocompleteService();
      const predictions = await new Promise(resolve => {
        service.getPlacePredictions({ input: text }, (preds, status) => {
          resolve(status === google.maps.places.PlacesServiceStatus.OK ? preds?.slice(0, 3) : []);
        });
      });

      if (predictions?.length) {
        const detailsService = new google.maps.places.PlacesService(document.createElement('div'));
        const placeResults = await Promise.all(predictions.map(p => new Promise(res => {
          detailsService.getDetails({ 
            placeId: p.place_id, 
            fields: ['types', 'geometry', 'user_ratings_total', 'rating', 'name']
          }, place => res(place));
        })));

        for (const place of placeResults) {
          if (!place?.types) continue;
          let distance = Infinity;
          let proximityBoost = 0;
          const isMajorPlace = place.types.some(t => 
            ['locality', 'country', 'administrative_area_level_1', 'natural_feature', 
             'continent', 'archipelago', 'colloquial_area'].includes(t)
          );
          if (userLat && userLng && place.geometry?.location) {
            distance = distanceKm(userLat, userLng, place.geometry.location.lat(), place.geometry.location.lng());
            if (!isMajorPlace) {
              if (distance < 1) proximityBoost = 0.5;
              else if (distance < 5) proximityBoost = 0.3;
              else if (distance < 20) proximityBoost = 0.15;
            }
          }
          const
